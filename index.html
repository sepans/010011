<html>
<head>
	<title>chrsmnn sepans 1</title>
		
	<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/jquery.window.min.js"></script>
	
	<script src="js/wikify.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/grid.js"></script>
	
	<script type="text/javascript" src="js/jquery.jsPlumb-1.3.16-all.js"></script>
	
	<script type="text/javascript" src="https://raw.github.com/kakiray/txtwiki.js/master/txtwiki.js"></script>



	<link href="css/jquery.window.css" rel="stylesheet" type="text/css"/>
	
	<link type="text/css" href="css/jquery.jscrollpane.css" rel="stylesheet" media="all" />
	
<!--	<link rel="stylesheet" href="css/wikify.css" type="text/css">-->
	
	<link rel="stylesheet" href="css/jquery-ui-1.9.2.custom.css" type="text/css">

	<link rel="stylesheet" href="css/chrsmnn.css" type="text/css">


	
	<!--<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>-->

	<script type="text/javascript" src="js/jquery.jscrollpane.min.js"></script>
	
	<script type="text/javascript" src="js/jquery.highlight-3.js"></script>
	
	<script type="text/javascript" src="js/dragscrollable.js"></script>

	
	<style type="text/css">

	
	</style>
	<script type="text/javascript">
	var descriptionWindow = [];
	var grids = [];
	var writingBox = null;
	var suggestionBox = null;
	
	var suggestionList = '';
	
	var WINDOW_WIDTH = 250;
	var WINDOW_HEIGHT = 300;

	var WRITE_WINDOW_WIDTH = 400;
	var WRITE_WINDOW_HEIGHT = 250;
	
	var searchCount = 0;
	var openedTextCount = 0; 
	
	var MAX_RESULTS_PER_BOX = 15;
	var MAX_SEARCH_RESULTS = 75;
	
	
	var BY_TERM_JSON = '/proxy.php?proxy_url='+'http://wikipedia-miner.cms.waikato.ac.nz/services/exploreArticle?outLinks=true%26parentCategories=true%26linkRelatedness=true%26responseFormat=json%26title=';

	var THES_JSON = '/proxy.php?proxy_url=http://words.bighugelabs.com/api/2/173aaf6b8cc559ac582b75f5ef7a8c8c/';
	
	var windowIndex = 0;
	
	var blueTexts = {};
	
	var endpointOptions = { endpoint:"Rectangle",
			paintStyle:{ width:25,height: 20,  fillStyle:'#555' },
			isSource:true,
			connectorStyle : { strokeStyle:"#00F" },
			isTarget:true, 
			anchor: "TopCenter"
			};
	var redEndpointOptions = { endpoint:"Rectangle",
			paintStyle:{ width:25,height: 20,  fillStyle:'#555' },
			isSource:true,
			connectorStyle : { strokeStyle:"#F00" },
			isTarget:true, 
			anchor: "TopCenter"
			};
	
	var greenEndpointOptions = { endpoint:"Rectangle",
			paintStyle:{ width:25,height: 20,  fillStyle:'#555' },
			isSource:true,
			connectorStyle : { strokeStyle:"#147C04" },
			isTarget:true, 
			anchor: "TopCenter"
			};

		$(document).ready( function() {
	
		//openFirstBox();
		//openWriteBox();
		
		$('.search_box').focus();
		$('.search_box').select();
		
	
        
        jsPlumb.ready(function() {

			jsPlumb.Defaults.Container = $("body");
			jsPlumb.importDefaults({
			    ConnectorZIndex:4000,
			    Connector :  "Straight" ,
			  //  Endpoint : "Blank",
			    PaintStyle : { lineWidth : 1, strokeStyle : "#00F" },
  				Anchors : [ "TopCenter", "BottomCenter" ]
  			});
  			
  			jsPlumb.bind("jsPlumbConnection", function(info) {
  				var sourceTxt = info.source.parent().text();
  				var targetTxt = info.target.parent().text();
  				console.log(info);
				var sourceWindow = info.source.parents('.window_panel');//parent().parent().parent().parent();
				var targetWindow = info.target.parents('.window_panel');//parent().parent().parent().parent();
 
				
				var x = (info.source.position().left+info.target.position().left+
						sourceWindow.position().left+targetWindow.position().left)/2 -WINDOW_WIDTH/2;

				var y = (info.source.position().top+info.target.position().top+
						sourceWindow.position().top+targetWindow.position().top)/2 -50;
						
				if(info.source.hasClass('wm_wikifiedLink')) {	//wikified anchor
				
				   console.log('wikified source ');
				   var sourceWord = info.source.text();
				   var targetWord = info.target.text();
				   		$.getJSON("search_all.php?keyword="+sourceWord, function(data1) {
				   			
							$.getJSON("search_all.php?keyword="+targetWord, function(data2) {

								var result1= data1[Math.floor(Math.random()*data1.length)];
								
								var result2= data2[Math.floor(Math.random()*data2.length)];
								

								
								console.log(result1);
								console.log(result2);

								$.getJSON("search.php?id="+result1.id+"&wordIndex="+result1.wordIndex, function(para1) {
										console.log(para1);									
									$.getJSON("search.php?id="+result2.id+"&wordIndex="+result2.wordIndex, function(para2) {
											console.log(para1);	
											console.log(para2);	
											console.log(para1[0].body);	
											console.log(para2[0].body);	

											var length = Math.round((para1[0].body.length + para2[0].body.length) /2);


											$.ajax({
												url: 'markov.php?order=5&begining='+sourceWord+'&length='+length+'&content='+para1[0].body+' '+para2[0].body,
												context: document.body
												}).done(function(data) { 
												  var textCont = "<div class='red_text_cont'>..."+data+"...</div>"; 
									
												  var blueGrid = openWindow(x,y,2000, WINDOW_WIDTH, WINDOW_HEIGHT ,textCont ,  '','red_text');	
												  var height = blueGrid.window.getContainer().find('.red_text_cont').height();
												  console.log('win h '+height);
												  blueGrid.window.resize(WINDOW_WIDTH,height+40);	
												 // '.window_frame'
												  $(blueGrid.window.getContainer()).find('.window_frame').height(height+30);
												  
												  $(blueGrid.window.getContainer()).find('.window_frame').highlight(sourceWord);
												  $(blueGrid.window.getContainer()).find('.window_frame').highlight(targetWord);
												  
												  jsPlumb.addEndpoint($("#"+blueGrid.window.getContainer().attr('id')+" .highlight"), greenEndpointOptions);
			 
												  jsPlumb.draggable(blueGrid.window.getContainer());

										
												  blueTexts[info.source]=blueGrid;
										  });								
									
									});
								
								});
				   			
				   				
				   			});
				   			
				   		});
				   		info.source.css('color', '#F00');
					    info.target.css('color', '#F00');


				   
				}
				else {
				
					var color = (info.source.parents('.red_text').length>0 || info.source.parents('.blue_text').length>0 ||
						info.target.parents('.red_text').length>0 || info.target.parents('.blue_text').length>0) ? 'green' : 'blue';
						
					var div = '<div class="'+color+'_overlay">'+sourceTxt+' '+targetTxt+'</div>';
					/*
					info.target.parent().parent().append(div);
					
					*/
							
					var length = Math.round((sourceTxt.length + targetTxt.length) /2);
					console.log('length '+length);
					
					var order = color=='blue' ? 6 : 4;
							
					$.ajax({
						url: 'markov.php?order='+order+'&begining='+info.source.text()+'&length='+length+'&content='+sourceTxt+' '+targetTxt,
						context: document.body
						}).done(function(data) { 
						  var textCont = "<div class='"+color+"_text_cont'>..."+data+"...</div>"; 
			
						  var blueGrid = openWindow(x,y,2000, WINDOW_WIDTH, WINDOW_HEIGHT ,textCont , '', color+'_text');	
						  var height = blueGrid.window.getContainer().find('.'+color+'_text_cont').height();
						  console.log('win h '+height);
						  blueGrid.window.resize(WINDOW_WIDTH,height+40);	
						 // '.window_frame'
						  $(blueGrid.window.getContainer()).find('.window_frame').height(height+30);
				
						  blueTexts[info.source]=blueGrid;
						  if(color!='green') {
							  
							  $(blueGrid.window.getContainer()).find('.window_frame').highlight(info.source.text());
							  $(blueGrid.window.getContainer()).find('.window_frame').highlight(info.target.text());
													  
							  jsPlumb.addEndpoint($("#"+blueGrid.window.getContainer().attr('id')+" .highlight"), greenEndpointOptions);
				 
							  jsPlumb.draggable(blueGrid.window.getContainer());
						}

					});
					
					
					info.source.css('color', '#00F');
					info.target.css('color', '#00F');
				}
			});

  			jsPlumb.bind("jsPlumbConnectionDetached", function(info) {
				info.source.css('color', '#666');
				info.target.css('color', '#666');
				//console.log(info.target.parent().parent().find('.blue_overlay'));
				//info.target.parent().parent().find('.blue_overlay').css('opacity',0);
				
				var grid = blueTexts[info.source];
				console.log(grid);
				console.log(grid.window);
				grid.window.close();
				
				
				
			});
	

		});						
	
	
	}); 
	

	
	function addSelectionToBox() {
	
		var selectedText = getSelectedText();
		var text = $.trim($('.window_container .write_note_box').val());
		text= text+" "+selectedText;
		console.log('val '+text);
		$('.window_container .write_note_box').val(text);
		console.log('val '+$('.window_container .write_note_box').val());
		
	}
	
	function getSelectedText() {
		if (window.getSelection) {
			return window.getSelection();
		}
		else if (document.selection) {
			return document.selection.createRange().text;
		}
		return '';
		}

	
	function openWriteBox() {
	
		
		//var top = $('body').scrollTop()+50;
		//var left = $('body').scrollLeft()+50;
		
		var top= $(window).height()-WRITE_WINDOW_HEIGHT-5;
		var left= $(window).width()/2-WRITE_WINDOW_WIDTH/2;
		//alert('write top '+top+' left '+left+ ' window height '+$(window).height()+ ' document height '+$(document).height());
		

		if(writingBox==null) {
			var content=$("#write_window").html();
			writingBox = $.window({
				title: " ",
				content: content,
				resizable: true,
				width: WRITE_WINDOW_WIDTH,
				height: WRITE_WINDOW_HEIGHT,
				x:  left,
				y: top,
				z: 3000,
				containerClass: 'write_container',
				 afterResize: function(wnd) { 
				 
				 	var width = wnd.getContainer()[0].offsetWidth-50;
				 	var height = wnd.getContainer()[0].offsetHeight-80;
  				    $(wnd.getContainer().find('.write_note_box')[0]).css('width',width+'px');
  				    $(wnd.getContainer().find('.write_note_box')[0]).css('height',height+'px');
   				}
			});
			writingBox.getHeader().find('.minimizeImg').css('display','block');
			writingBox.getHeader().find('.closeImg').css('display','none');
			//writingBox.getContainer().css('z-index',2050); 
			//writingBox.alignHorizontalCenter();
			
			//document.getElementById("write_textarea").value="";
		}
		else {
			//writingBox.move(left,top,false);
			if(writingBox.isMinimized()) {
				writingBox.restore();
			}
			//writingBox.getContainer().css('z-index',2050); 
		}
		return false;

	
	}
	
	
	function getGridForElement(element) {
	
		var thisWindow =  $(element).parents('.window_container');
		var gridIndex = $(thisWindow).find('.grid_index').val();
		return textContent = grids[gridIndex];
	}

	function openWindow(x,y,z, width, height , content ,  title, containerClassName) {
		descriptionWindow[windowIndex] = $.window({
			title: title!=null ? title : " ",
			content: content,
			resizable: true,
			width: width,
			height: height,
			x:  x,
			y: y,
			containerClass: containerClassName
		});
		grids[windowIndex] = new GridElement(windowIndex,descriptionWindow[windowIndex]); 


		windowIndex++;
		return grids[windowIndex-1];

   }
	
	
	function search(searchBox)
	{
		var term = searchBox.value;
		searchByTerm(term);
		
		openWriteBox();


 		
		
		return false;
	}
	
	function searchByTerm(term) {
		var author='';
		if(term.indexOf(',')>0) {
			author = term.substring(0,term.indexOf(',')).trim();
			term = term.substring(term.indexOf(',')+1).trim();
			console.log('term '+term+' author '+author);
		}
	
		$.getJSON("search_all.php?keyword="+term+"&author="+author, searchCallback(term));
		//$(searchBox.offsetParent).find('.change_to_note').css('display','none');
		$.getJSON("http://search.twitter.com/search.json?rpp=5&include_entities=true&result_type=mixed&lang=en&q="+term+"&callback=?", searchTwitterCallback());
		
		setTimeout(function() {
			searchWikiminer(term);
		},2000);
		
		setTimeout(function() {
			thesaurusSyns(term);
		},2000);	
		
		suggestionList = '';
	}
	
	function searchTwitterCallback() {
		return function(data) {
			if(data.results.length>0) {
				$('.window_frame #twitter_result').text(data.results[0].text);
			}
		};	
	}
	
	
	function searchCallback(term) {
		return function(data) {
     		////console.log('searchBox:');
			////console.log(searchBox);
			console.log('term '+term);
			var results = '';
			if(data.length==0)
				results = 'No results';
			var author='';
			//var authors;
			var window;
			var authorCount = 0;
			var resultPerAuthorCount = 0;
			
			var resultsPerBox = 0;
			console.log(data.length);
			var ignoredResults =0;
			var acceptedResults =0;
			var boxCount = 0;

			var ratio = data.length>MAX_SEARCH_RESULTS ? MAX_SEARCH_RESULTS/data.length : 1;
			
			$.each(data, function(i,item){
				var result = '';
				
				

				if(author==item.author) {
					authorCount++;
					resultPerAuthorCount++;
				}
				else {
					resultPerAuthorCount = 0;
					author = item.author;
				
				}
				result=result+'<li><a href="#" onclick="list_titles(this,\''+item.author+'\');return false;">'+item.author+'</a>, '
								 +'<a href="#" onclick="search_result(this,'+item.id+','+item.wordIndex+',\''+term+'\');return false;">'+item.title+"</a>";
				result=result+'<input type="hidden" id="search_result_hidden_index" value="'+item.wordIndex+'"/>';
				result=result+'<p>'+item.sentence+'</p></li>';
				
				if(ratio<1) {
					if(Math.random()<ratio) {
					
						results=results+result;
						acceptedResults++;
						resultsPerBox++;
						//console.log('adding result'+ item.author+' '+item.title);
					}
					else {
						ignoredResults++;
					//	console.log('#### ignored result'+ item.author+' '+item.title);
						}
				
				}
				else {
					results=results+result;
					resultsPerBox++;
					acceptedResults++;
				}
				
				if(resultsPerBox>MAX_RESULTS_PER_BOX || ignoredResults+acceptedResults==data.length) {
				 	console.log(resultsPerBox+' max: ' +MAX_RESULTS_PER_BOX);
					results = '<div class="window_container"><div class="result_container"><ul class="results_box">'+results+'</ul></div></div>';
					
					var height =   WINDOW_HEIGHT+Math.random()*40 ;
					
					var windowX = boxCount*(WINDOW_WIDTH)*.91+(searchCount%2)*WINDOW_WIDTH/2+10;//+Math.random()*40;
					console.log('windowX '+windowX);
					
					var windowY = 55+Math.random()*30-15+searchCount*100;
					
					if(windowX+WINDOW_WIDTH+20>$(document).width()) {
						
						windowY+= 120;
						windowX=windowX%$(document).width();
						
					}
						
					var grid = openWindow(windowX, windowY ,2000, WINDOW_WIDTH, height , results ,  '', 'search_container');
					var window=grid.window;
					
					$(window.getContainer()).find('.results_box p').highlight(term,{wordsOnly: true});
		
		 			/*jsPlumb.addEndpoint($("#"+window.getContainer().attr('id')+" .highlight"), endpointOptions);
		 
					 jsPlumb.draggable(window.getContainer());

					*/
					
					results='';
					
					boxCount++;
					
					/*
					if(authorCount==-1) {
						authorCount = 0;
					}
					*/
					resultsPerBox=0;
					
				
				}
          
        });
        //	var thisWindow =  $(searchBox).parents('.window_container');

		//	$(thisWindow).find('.results_box').html(results);
		console.log('data.length '+data.length);
		if(data.length>0)
			searchCount++;
		console.log('ignored '+ignoredResults);
		console.log('accepted '+acceptedResults);
		
		$('.search_box')[0].value='';
		
		$('.write_container .write_note_box').focus();


		};
	}


	function search_result(result,article_id,wordIndex,term)
	{
		//alert(result.nextElementSibling.value);

		//todo pass word and index to searchResultCallback
		
		//var grid = getGridForElement(result);
		//grid.changeMode('search_result');
		console.log('wi '+wordIndex);
		
		var target = result.parentNode.parentNode;//.parentNode;
		$.getJSON("search.php?id="+article_id+"&wordIndex="+wordIndex, searchResultCallback($(target),term));

		//result.parentNode.parentNode.parentNode.innerHTML = $('#desc_window .window_container').html();
		return false;
	}
	
	


	
	function searchResultCallback(target,term) {
		return function(data) {
		////console.log('callback');
			console.log('target');
			console.log(target);
			var dataItem = data[0];
			var result = '';
			var body = dataItem.body;
			body.replace(/â€™/g,'\'')
			result = '<div class="wikify_slider"></div><div class="text_section"><h2>'+dataItem.title+'</h2><p>'+body+'</p></div>';
			
			//<input class="local_search" onkeyup="if (event.keyCode == 13) {localSearch(this);}"/>
			
		
		var container = $(target).parents('.window_panel');//parent().parent().parent().parent();
		/*if(!container.parent().parent()) { // it is a result from a list not search
			console.log('list it is ');
			var container = $(target).parent().parent();
		}*/
		console.log('container');
		console.log(container);
		var top= $(container).position().top;
		var left = $(container).position().left;

	
		
		createWindow(left,top,result,term);

		

		
	};
	}
	
	function createWindow(left,top,result,term) {  // top and left are the original window top left (where link was)
	
		console.log('container parent top '+top+' left '+left);
		left=left+WINDOW_WIDTH+20+Math.random()*20;
		if(top<5) {
			top=5;
		}
		if(left+WINDOW_WIDTH>$(document).width()) {
			left=left-2*WINDOW_WIDTH;
		}
		console.log('container corrected top '+top+' left '+left);
	
		var grid =openWindow(left,top,2000, WINDOW_WIDTH, WINDOW_HEIGHT , result ,  '', 'result_box');
		
		var window = grid.window;
		
		var lineHeight = (12+openedTextCount%3)+'px';
		console.log('lineHeight '+lineHeight);
		openedTextCount++;

		$(window.getContainer()).find('.text_section').css('line-height', lineHeight);
		 
		 var height =$(window.getContainer()).find('.text_section').height()+30; // 30 for input box
		 console.log(height);

		 if(height<1000) {
			 window.resize(WINDOW_WIDTH,height*1.1+20);
			 $(window.getContainer()).find('.window_frame').height(height+15);
			
			 console.log('container ');
			 console.log($(window.getContainer()).find('.window_frame'));
			  
	
		}
		console.log(' highlight term '+term);

		$(window.getContainer()).find('.wikify_slider').slider({max: 100, value: 0,
	  		 stop: function(event, ui) {

			var targetBox = $(event.target).parent().find('.text_section p');
			var text = targetBox.text();
			var prob = 1-ui.value/100;
			wikifyText(text,prob,targetBox);
			
		   }
		});
		
		if(term!='') {
			$(window.getContainer()).find('.text_section p').highlight(term, {wordsOnly: true});
			
			 jsPlumb.addEndpoint($("#"+window.getContainer().attr('id')+" .highlight"), endpointOptions);
			 
			 jsPlumb.draggable(window.getContainer());
			 
			 console.log(window.getContainer());
		}
		
		
	
	}
		
	function wikifyText(text,probability,target) {
		
			var proxy_url = '/proxy.php?proxy_url=http://wikipedia-miner.cms.waikato.ac.nz/services/wikify';
			
			$.post(proxy_url, {source: text.substring(0,10000), minProbability : probability, repeatMode: 'ALL',
			responseFormat: 'DIRECT', linkFormat: 'html_id_weight', tooltips: true, },
			//var thisi=0;
			(function(target) {
			  return function(data) {
				 wikifyCallback(data, target);
			  };
		   }(target)) // calling the function with the current value
		);

	  }
	  
	  function wikifyCallback(data,target) {
	  	
	  	
	  	var window = target.parents('.window_panel');
	  	
	  	var initialSearchTerm =  target.parents('.window_frame').find('.highlight').text();

	  	target.html(data);
	  	
	  	// for initial term
	  	window.find('.window_frame p').highlight(initialSearchTerm);
	  	jsPlumb.addEndpoint($("#"+window.attr('id')+" .highlight"), endpointOptions);
	  	
	  	//for wikified terms
	  	jsPlumb.addEndpoint($("#"+window.attr('id')+" .wm_wikifiedLink"), redEndpointOptions);
		 
		 jsPlumb.draggable(window);
		 
		 target.find('.wm_wikifiedLink').click(function (event) {
		 	
		 	var x = $(event.target).parents('.window_panel').position().left;
		 	var y = $(event.target).parents('.window_panel').position().top;
		 	var pageId = $(event.target).attr('pageId');
		 	console.log(x+' y '+y+' p '+pageId);
		    var wiki_api = '/proxy.php?proxy_url='+'http://en.wikipedia.org/w/api.php?action=query%26prop=revisions%26rvprop=content%26format=json%26pageids='+pageId;
			//var wiki_api = 'http://en.wikipedia.org/w/index.php?action=render&title='
			$.ajax({
				type: "GET",
				url: wiki_api,
				dataType: "json",
				success: function(data) {
      			 openWikiWindow(data, x,y,pageId);
     			}
  			});
			
		 	
		 	return false;
		 });
		 
		// console.log(window.getContainer());
	  }
	  
	   function openWikiWindow(data, x,y,pageId)
	  {
			console.log(data.query);
		 	console.log('x '+x+' y '+y);
			var rawWiki = data.query.pages[pageId].revisions[0]['*'];
			var plainWiki =txtwiki.parseWikitext(rawWiki);
			plainWiki = plainWiki.substring(0,plainWiki.indexOf('=='));
			
			console.log(plainWiki);
			plainWiki=plainWiki.replace(/{{(.*?)}}/g,'');
//			plainWiki=plainWiki.replace(/{{(.*?)}}/g,'');
			plainWiki = plainWiki.lastIndexOf('}}')>0 ? plainWiki.substring(plainWiki.lastIndexOf('}}')+2) : plainWiki;
			plainWiki = plainWiki.lastIndexOf('(disambiguation)')>0 ? plainWiki.substring(plainWiki.lastIndexOf('(disambiguation)')+15) : plainWiki;

//			plainWiki=plainWiki.replace(/|(.*?)|/g,'');
			console.log(plainWiki);
			var result = '<div class="wikify_slider"></div><div class="text_section"><h2>'+data.query.pages[pageId].title+'</h2><p>'+plainWiki+'</p></div>';
			//var grid =openWindow(x,y,2000, WINDOW_WIDTH, WINDOW_HEIGHT , plainWiki ,  '', 'wiki_box');
			
			createWindow(x,y,result,'');

	  }
		
		
		

		
	
	
	function localSearch(inputBox) {
		var term = inputBox.value;
		console.log($(inputBox).parent());
		$(inputBox).parent().find('.text_section p').highlight(term);
		
		jsPlumb.addEndpoint($(inputBox).parent().find('.text_section p .highlight'), endpointOptions);
		 
		 jsPlumb.draggable(window.getContainer());

	}

	function searchResultNewBox(chck,position) {
	
		var grid = getGridForElement(chck);

		var thisWindow = grid.window.getContainer()[0]; //why [0] ?!
		
		//var thisWindow =  $(chck).parents('.window_container').offsetParent()[0];
		//var thisWindowOld = chck.offsetParent;
		var newGrid = openAdjacentWindow(chck,$('#desc_window').html(),thisWindow);
		

		

		
		var article_id = $(chck.parentNode.parentNode).find('.search_result_hidden')[0].value;

		//$(descriptionWindow[windowIndex-1].getFrame()).find('.change_to_note').css('display','none');
		newGrid.changeMode('search_result');

		var target = descriptionWindow[windowIndex-1].getFrame().find('ul');

		$.getJSON("search.php?id="+article_id+"", searchResultCallback(target));

		
		//descriptionWindow[windowIndex-1]
	}

		


	function list_titles(result,author)
	{
		//alert(result.nextElementSibling.value);

		//todo pass word and index to searchResultCallback
		
		//var grid = getGridForElement(result);
		//grid.changeMode('search_result');
		
		var target = result.parentNode.parentNode;//.parentNode;
		$.getJSON("list.php", listTitlesCallback($(target),author));

		//result.parentNode.parentNode.parentNode.innerHTML = $('#desc_window .window_container').html();
		return false;
	}

	
	function listTitlesCallback(target,author) {
		return function(data) {

			var result = '<ul class="title_list">';
			console.log('target');
			console.log(target);
			var prevAuthor = '';
			$.each(data, function(index, value) { 
				var anchor = '';
				if(value.author!=prevAuthor) {
					prevAuthor = value.author;
					anchor = '<a name="'+value.author+'"/>';
				}
				result += '<li>'+anchor+'<a href="#" onclick="search_result(this,'+value.id+');return false">'+value.author+' '+value.title+'</a></li>';
			
			});
			result +='</ul>';
		////console.log(target);
		
		//var container = $(target).parent().parent().parent().parent();// replaced with following line
		
		var container = $(target).parents('.window_panel');
		
		//console.log('container');
		//console.log(container);
		/*var top= $(container).position().top;
		var left = $(container).position().left;
		console.log('top '+top+' left '+left);
		var grid =openWindow(left+WINDOW_WIDTH+20,top,2000, WINDOW_WIDTH, WINDOW_HEIGHT , result ,  '', 'result_box');
		*/
		
		var top= $(container).position().top+Math.random()*20;
		var left = $(container).position().left;

		console.log('container top '+top+' left '+left);
		left=left+WINDOW_WIDTH+20+Math.random()*20;
		if(top<5) {
			top=5;
		}
		if(left+WINDOW_WIDTH>$(document).width()) {
			left=left-2*WINDOW_WIDTH;
		}
		console.log('container corrected top '+top+' left '+left);
		var grid =openWindow(left,top,2000, WINDOW_WIDTH, WINDOW_HEIGHT , result ,  '', 'result_box');
		
		
		scrollToAnchor(author, $(grid.window.getContainer()).find('.window_frame'),grid.window.getContainer().attr('id'));
		//var window = grid.window;
		 
	

		};
	}
	
	function scrollToAnchor(aid, scroll_container,container_id){
    	console.log(container_id);
    	var path ="#"+container_id+" a[name='"+ aid +"']";
    	console.log(path);
    	var aTag = $(path);
    	console.log('aTag');
    	console.log(aTag);
    	console.log(container);
    	console.log('top '+ aTag.offset().top);
    	console.log('scroll'+ scroll_container.scrollTop());
	    scroll_container.animate({scrollTop: aTag.offset().top-80},'fast');
	   //container.scrollTop=aTag.offset().top;
    	console.log('scroll 2'+ scroll_container.scrollTop());
	}

	
	
	function thesaurusSyns(term) {
	
		$.getJSON(THES_JSON+term+'/json', function(data) {
				var suggestions_html ='';
				var index = 0;
				for (var key in data) {
					if(key==undefined)
						continue; 
					$.each(data[key].syn, function(index,item) {
						if(index<5) {
							suggestions_html+='<li><a href="#" onclick="searchByTerm(\''+item+'\');return false;"> '+item+'</li>';
							//console.log(item.title);
							index++;
						}
					});

				}
	//			console.log(suggestions_html);
				//openWindow(40, 500,4000,400,250,suggestions_html,'');
                                if(suggestionList.length>0) {
                                        suggestionList+='<li>&nbsp;</li>';
                                }

				suggestionList+=suggestions_html;
				//console.log(suggestionList);
				//openSuggestionBox('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
				$('.write_container .suggestions').html('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
		});
	}
	
	function searchWikiminer(term) {
		processArticleJSON(BY_TERM_JSON+term,term);
	}
	
//	http://words.bighugelabs.com/api/2/173aaf6b8cc559ac582b75f5ef7a8c8c/interface/json
	
	function processArticleJSON(url,term) {
	
				console.log('wiki search');
				$.getJSON(url, function(data) {
				json_cache = data;
				var sortedLinks = sortJSON(data,'relatedness');
				console.log(data.id);
				var suggestions_html ='';
				$.each(sortedLinks, function(index,item) {
					if(index<7) {
						suggestions_html+='<li><a href="#" onclick="searchByTerm(\''+item.title.toLowerCase()+'\');return false;"> '+item.title.toLowerCase()+' </a></li>';
						//console.log(item.title);
						index++;
					}
				});
//				console.log(suggestions_html);
				if(suggestionList.length>0) {
					suggestionList+='<li>&nbsp;</li>';
				}
				suggestionList+=suggestions_html;
				//console.log(suggestionList);

				//openWindow(40, 300,4000,400,250,suggestions_html,'');
				//openSuggestionBox('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
				$('.write_container .suggestions').html('<ul class="wiki_suggestions">'+suggestionList+'</ul>');

			});
	}
	
	function sortJSON(data,sortMethod) {
		var ret;
		console.log(sortMethod);
		if(sortMethod=='relatedness') {
			ret=data.outLinks.sort(function(a,b) { return parseFloat(b.relatedness) - parseFloat(a.relatedness) } );
		}
		else {
			console.log('sort method is title');
			ret=data.outLinks.sort(function(a,b) { return a.title > b.title ? 1 : -1 } );
		}
		return ret;
	}
	
	function save_to_desktop() {
		var content = $('.window_frame #write_textarea').val();
		console.log('content '+content);
		/*$.ajax({
  			url: "save.php?method=desktop&content="+content,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		});*/
		window.open("save.php?method=desktop&content="+content,"_self")
		
	
	}
	
	function send_email() {
		var content = $('.window_frame #write_textarea').val();
		console.log('content '+content);
		/*$.ajax({
  			url: "save.php?method=desktop&content="+content,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		});*/
		
		//$( "#dialog-form" ).dialog( "open" );

		
		var to = prompt('email address (separated by comma)');
		if(to!=null && to!='') {
		  $.ajax({
  			url: "save.php?method=email&content="+content+"&to="+to,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		  });
		
		}
		
		//	window.open("save.php?method=email&content="+content+"&to="+to,"_self")
	
	
	}
	
	function contact_email() {
		var content = $('.window_frame #write_textarea').val();
		var to = 'chrsmnn@gmail.com';
		if(to!=null && to!='') {
		  $.ajax({
  			url: "save.php?method=email&content="+content+"&to="+to,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		  });
		}
		
	
	}
	
	function checkRegexp( o, regexp, n ) {
            if ( !( regexp.test( o.val() ) ) ) {
             //   o.addClass( "ui-state-error" );
              //  updateTips( n );
                return false;
            } else {
                return true;
            }
        }
	
	
</script>
</head>
<body>
	<div id="container">

		
	<div class="search_input">
		<input type="text" class="search_box" tabindex="0" onkeyup="if (event.keyCode == 13) {search(this);}"/>
	</div>
		
 



	
	<div id="write_window" style="display:none">
		<div class="write_container window_container">
			<div class="suggestions">
			</div>
			<textarea class="write_note_box" id="write_textarea">&nbsp;</textarea>
			
			<!--<a href="#" onclick="addSelectionToBox()">Add selection to notes</a>-->
			<span class="save">
				<!--<a href="#" >&nbsp;</a>-->
			<ul class="save-options">
					<li><a href="#" onclick="save_to_desktop();return false;">desk</a></li>
					<li><a href="#" onclick="send_email();return false;">email</a></li>
					<li><a href="#" onclick="contact_email();return false;">contact</a></li>
			</ul>
			</span>
			<div id="twitter_result"></div>
			
		</div>
	</div>

	
	


	</div>

	<div id="tooltip" class="ui-corner-all">
<div class="loading"></div>
</div>

	

</body>
	
