<html>
<head>
	<title>chrsmnn sepans 1</title>
		
	<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
	<script type="text/javascript" src="js/jquery.window.min.js"></script>
	<script src="js/wikify.js" type="text/javascript"></script>
	<script type="text/javascript" src="js/grid.js"></script>

	<link href="css/jquery.window.css" rel="stylesheet" type="text/css"/>
	
	<link type="text/css" href="css/jquery.jscrollpane.css" rel="stylesheet" media="all" />
	
<!--	<link rel="stylesheet" href="css/wikify.css" type="text/css">-->
	
	<link rel="stylesheet" href="css/chrsmnn.css" type="text/css">

	
<!--	<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>-->
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

	<script type="text/javascript" src="js/jquery.jscrollpane.min.js"></script>
	
	<script type="text/javascript" src="js/jquery.highlight-3.js"></script>
	
	<script type="text/javascript" src="js/dragscrollable.js"></script>

	
	<style type="text/css">

	
	</style>
	<script type="text/javascript">
	var descriptionWindow = [];
	var grids = [];
	var writingBox = null;
	var suggestionBox = null;
	
	var suggestionList = '';
	
	var WINDOW_WIDTH = 250;
	var WINDOW_HEIGHT = 300;

	var WRITE_WINDOW_WIDTH = 400;
	var WRITE_WINDOW_HEIGHT = 255;
	
	var searchCount = 0;
	
	
	var BY_TERM_JSON = '/proxy.php?proxy_url='+'http://wikipedia-miner.cms.waikato.ac.nz/services/exploreArticle?outLinks=true%26parentCategories=true%26linkRelatedness=true%26responseFormat=json%26title=';

	var THES_JSON = '/proxy.php?proxy_url=http://words.bighugelabs.com/api/2/173aaf6b8cc559ac582b75f5ef7a8c8c/';
	
	var windowIndex = 0;
	
		$(document).ready( function() {
	
		//openFirstBox();
		//openWriteBox();
		
		$('.search_box').focus();
		$('.search_box').select();
		
		/*
		$( "#dialog-form" ).dialog({
            autoOpen: false,
            height: 100,
            width: 100,
            modal: false,
            buttons: {
                "send email": function() {
                    var bValid = true;
                    //allFields.removeClass( "ui-state-error" );
 
                    //bValid = bValid && checkLength( email, "email", 6, 80 );
 
                    bValid = bValid && checkRegexp( email, /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i, "eg. ui@jquery.com" );
 
                    if ( bValid ) {
					  $.ajax({
						url: "save.php?method=email&content="+content+"&to="+to,
						context: document.body
						}).done(function() { 
						  console.log('ajax done');
					  });
                      $( this ).dialog( "close" );
                    }
                },
                Cancel: function() {
                    $( this ).dialog( "close" );
                }
            },
            close: function() {
               // allFields.val( "" ).removeClass( "ui-state-error" );
            }
        });
        */
	
	}); 

	
	function addSelectionToBox() {
	
		var selectedText = getSelectedText();
		var text = $.trim($('.window_container .write_note_box').val());
		text= text+" "+selectedText;
		console.log('val '+text);
		$('.window_container .write_note_box').val(text);
		console.log('val '+$('.window_container .write_note_box').val());
		
	}
	
	function getSelectedText() {
		if (window.getSelection) {
			return window.getSelection();
		}
		else if (document.selection) {
			return document.selection.createRange().text;
		}
		return '';
		}

	
	function openWriteBox() {
	
		
		//var top = $('body').scrollTop()+50;
		//var left = $('body').scrollLeft()+50;
		
		var top= $(window).height()-WRITE_WINDOW_HEIGHT;
		var left= $(window).width()/2-WRITE_WINDOW_WIDTH/2;
		//alert('write top '+top+' left '+left+ ' window height '+$(window).height()+ ' document height '+$(document).height());
		

		if(writingBox==null) {
			var content=$("#write_window").html();
			writingBox = $.window({
				title: " ",
				content: content,
				resizable: true,
				width: WRITE_WINDOW_WIDTH,
				height: WRITE_WINDOW_HEIGHT,
				x:  left,
				y: top,
				z: 3000,
				containerClass: 'write_container',
				 afterResize: function(wnd) { 
				 
				 	var width = wnd.getContainer()[0].offsetWidth-50;
				 	var height = wnd.getContainer()[0].offsetHeight-80;
  				    $(wnd.getContainer().find('.write_note_box')[0]).css('width',width+'px');
  				    $(wnd.getContainer().find('.write_note_box')[0]).css('height',height+'px');
   				}
			});
			writingBox.getHeader().find('.minimizeImg').css('display','block');
			writingBox.getHeader().find('.closeImg').css('display','none');
			//writingBox.getContainer().css('z-index',2050); 
			//writingBox.alignHorizontalCenter();
			
			//document.getElementById("write_textarea").value="";
		}
		else {
			//writingBox.move(left,top,false);
			if(writingBox.isMinimized()) {
				writingBox.restore();
			}
			writingBox.getContainer().css('z-index',2050); 
		}
		return false;

	
	}
	
	/*
		function openSuggestionBox(content) {
	
		
		var top = $(window).height()-WINDOW_HEIGHT-10;
		var left = 0;//$(window).width()-WINDOW_WIDTH-10;
		console.log('top '+top+' left '+left);
		

		if(suggestionBox==null) {
			//var content=$("#write_window").html();
			suggestionBox = $.window({
				title: " ",
				content: content,
				resizable: true,
				width: WINDOW_WIDTH+40,
				height: WINDOW_HEIGHT,
				x:  left,
				y: top
			});
			suggestionBox.getHeader().find('.minimizeImg').css('display','block');
			suggestionBox.getHeader().find('.closeImg').css('display','none');
			suggestionBox.getContainer().css('z-index',2050); 
			//suggestionBox.alignHorizontalCenter();
		}
		else {
			//suggestionBox.move(left,top,false);
			if(suggestionBox.isMinimized()) {
				suggestionBox.restore();
			}
			suggestionBox.setContent(content);
			suggestionBox.getContainer().css('z-index',2050); 
		}
		return false;

	
	}
	*/
	
	
	

	
	function getGridForElement(element) {
	
		var thisWindow =  $(element).parents('.window_container');
		var gridIndex = $(thisWindow).find('.grid_index').val();
		return textContent = grids[gridIndex];
	}

	function openWindow(x,y,z, width, height , content ,  title, containerClassName) {
		descriptionWindow[windowIndex] = $.window({
			title: title!=null ? title : " ",
			content: content,
			resizable: true,
			width: width,
			height: height,
			x:  x,
			y: y,
			containerClass: containerClassName
		});
		grids[windowIndex] = new GridElement(windowIndex,descriptionWindow[windowIndex]); 


		windowIndex++;
		return grids[windowIndex-1];

}
	
	
	function search(searchBox)
	{
		var term = searchBox.value;
		searchByTerm(term);
		
		openWriteBox();


 		
		
		return false;
	}
	
	function searchByTerm(term) {
	
		$.getJSON("search_all.php?keyword="+term+"", searchCallback());
		//$(searchBox.offsetParent).find('.change_to_note').css('display','none');

		$.getJSON("http://search.twitter.com/search.json?rpp=5&include_entities=true&result_type=mixed&q="+term+"&callback=?", searchTwitterCallback());
		
		setTimeout(function() {
			searchWikiminer(term);
		},2000);
		
		setTimeout(function() {
			thesaurusSyns(term);
		},2000);	
		
		suggestionList = '';
	}
	
	function searchTwitterCallback() {
		return function(data) {
			if(data.results.lenght>0) {
				console.log(data.results[0].text);
			}
		};	
	}
	
	
	function searchCallback() {
		return function(data) {
     		////console.log('searchBox:');
			////console.log(searchBox);
			var results = '';
			if(data.length==0)
				results = 'No results';
			var author='';
			//var authors;
			var window;
			var authorCount = -1;
			var resultPerAuthorCount = 0;
			$.each(data, function(i,item){
				var result = '';
				if(author!=item.author && authorCount!=-1 && resultPerAuthorCount>15) {
					results = '<div class="window_container"><div class="result_container"><ul class="results_box">'+results+'</ul></div></div>';
					
					var height =   WINDOW_HEIGHT+Math.random()*40 ;
					//var randomX = Math.random()*WINDOW_WIDTH/6-WINDOW_WIDTH/10+50;
					//window = openWindow(authorCount*(WINDOW_WIDTH)+randomX,55+Math.random()*60-30,2000, WINDOW_WIDTH, height , results ,  '');
					
					var windowX = authorCount*(WINDOW_WIDTH)*1.05+(searchCount%2)*WINDOW_WIDTH/2+Math.random()*50-20;
					
					var windowY = 55+Math.random()*30-15+searchCount*100;
					window = openWindow(windowX, windowY ,2000, WINDOW_WIDTH, height , results ,  '', 'search_container');
					
					var results_height = Math.min($(window)[0].getResultContainer().height(),WINDOW_HEIGHT);
					//$(window)[0].window.resize(WINDOW_WIDTH,Math.min(results_height+40,1200));
					results='';
					resultPerAuthorCount = 0;
					author = item.author;
					
					authorCount++;
					//var thisWindow =  $(searchBox).parents('.window_container');

					//$(thisWindow).find('.results_box').html(results);
				
				}
				if(authorCount==-1) {
					authorCount = 0;
				}
				result=result+'<li><a href="#" onclick="list_titles(this,\''+item.author+'\');return false;">'+item.author+'</a>'
								 +'<a href="#" onclick="search_result(this,'+item.id+','+item.wordIndex+');return false;">'+item.title+"</a>";
//				result=result+'<input type="hidden" id="search_result_hidden" value="'+item.id+'"/>';
				result=result+'<input type="hidden" id="search_result_hidden_index" value="'+item.wordIndex+'"/>';
				result=result+'<p>'+item.sentence+'</p></li>';
				
				resultPerAuthorCount++;
				
				results=results+result;
          
        });
        //	var thisWindow =  $(searchBox).parents('.window_container');

		//	$(thisWindow).find('.results_box').html(results);
		if(authorCount>-1)
			searchCount++;
		
		$('.search_box')[0].value='';
		
		$('.write_container .write_note_box').focus();


		};
	}


	function search_result(result,article_id,wordIndex)
	{
		//alert(result.nextElementSibling.value);

		//todo pass word and index to searchResultCallback
		
		//var grid = getGridForElement(result);
		//grid.changeMode('search_result');
		console.log('wi '+wordIndex);
		
		var target = result.parentNode.parentNode;//.parentNode;
		$.getJSON("search.php?id="+article_id+"&wordIndex="+wordIndex, searchResultCallback($(target)));

		//result.parentNode.parentNode.parentNode.innerHTML = $('#desc_window .window_container').html();
		return false;
	}

	
	function searchResultCallback(target) {
		return function(data) {
		////console.log('callback');
			console.log('target');
			console.log(target);
			var dataItem = data[0];
			var result = '';
			var body = dataItem.body;
			body.replace(/â€™/g,'\'')
			result = '<div class="text_section"><h2>'+dataItem.title+'</h2><p>'+body+'</p></div>';
			
		////console.log(result);
		////console.log(target);
		
		var container = $(target).parent().parent().parent().parent();
		if(container.parent().parent()) { // it is a result from a list not search
			console.log('list it is ');
			var container = $(target).parent().parent();
		}
		console.log('container');
		console.log(container);
		var top= $(container).position().top;
		var left = $(container).position().left;
		console.log('container top '+top+' left '+left);
		var grid =openWindow(left+WINDOW_WIDTH+20,top,2000, WINDOW_WIDTH, WINDOW_HEIGHT , result ,  '', 'result_box');
		
		var window = grid.window;
		 
		 var height =$(window.getContainer()).find('.text_section').height();
		 console.log(height);
		// console.log(window.width);
		 if(height<1000) {
			 window.resize(WINDOW_WIDTH,height*1.1+20);
			 $(window.getContainer()).find('.window_frame').height(height+10);
	
			$(window.getContainer()).find('.text_section').highlight('search');
		}

		
		
		
		/*	
		target.html(result);
		
		$(target).highlight('search');
		var container = $(target).parent().parent().parent();
		var results_height = Math.min($(target).height()-20,WINDOW_HEIGHT);
		console.log('height '+results_height);
		console.log(container);
		$(container).css('height',results_height+40);

*/

		};
	}

	function searchResultNewBox(chck,position) {
	
		var grid = getGridForElement(chck);

		var thisWindow = grid.window.getContainer()[0]; //why [0] ?!
		
		//var thisWindow =  $(chck).parents('.window_container').offsetParent()[0];
		//var thisWindowOld = chck.offsetParent;
		var newGrid = openAdjacentWindow(chck,$('#desc_window').html(),thisWindow);
		

		

		
		var article_id = $(chck.parentNode.parentNode).find('.search_result_hidden')[0].value;

		//$(descriptionWindow[windowIndex-1].getFrame()).find('.change_to_note').css('display','none');
		newGrid.changeMode('search_result');

		var target = descriptionWindow[windowIndex-1].getFrame().find('ul');

		$.getJSON("search.php?id="+article_id+"", searchResultCallback(target));

		
		//descriptionWindow[windowIndex-1]
	}

		


	function list_titles(result,author)
	{
		//alert(result.nextElementSibling.value);

		//todo pass word and index to searchResultCallback
		
		//var grid = getGridForElement(result);
		//grid.changeMode('search_result');
		
		var target = result.parentNode.parentNode;//.parentNode;
		$.getJSON("list.php", listTitlesCallback($(target)));

		//result.parentNode.parentNode.parentNode.innerHTML = $('#desc_window .window_container').html();
		return false;
	}

	
	function listTitlesCallback(target) {
		return function(data) {

			var result = '<ul class="title_list">';
			console.log('target');
			console.log(target);
			$.each(data, function(index, value) { 
				
				result += '<li><a href="#" onclick="search_result(this,'+value.id+');return false">'+value.author+' '+value.title+'</a></li>';
			
			});
			result +='</ul>';
		////console.log(target);
		
		var container = $(target).parent().parent().parent().parent();
		//console.log('container');
		//console.log(container);
		var top= $(container).position().top;
		var left = $(container).position().left;
		console.log('top '+top+' left '+left);
		var grid =openWindow(left+WINDOW_WIDTH+20,top,2000, WINDOW_WIDTH, WINDOW_HEIGHT , result ,  '', 'result_box');
		
		//var window = grid.window;
		 
		/* var height =$(window.getContainer()).find('.text_section').height();
		 console.log(height);
		// console.log(window.width);
		 
		 window.resize(WINDOW_WIDTH,height*1.1+20);
		 $(window.getContainer()).find('.window_frame').height(height+10);

		$(window.getContainer()).find('.text_section').highlight('search');*/

		
		
		
		/*	
		target.html(result);
		
		$(target).highlight('search');
		var container = $(target).parent().parent().parent();
		var results_height = Math.min($(target).height()-20,WINDOW_HEIGHT);
		console.log('height '+results_height);
		console.log(container);
		$(container).css('height',results_height+40);

*/

		};
	}

	
	
	function thesaurusSyns(term) {
	
		$.getJSON(THES_JSON+term+'/json', function(data) {
				var suggestions_html ='';
				var index = 0;
				//console.log(data);
				for (var key in data) {
					//console.log(key);
					//console.log(data[key]);
					//console.log(data[key].syn);
					if(key==undefined)
						continue; 
					$.each(data[key].syn, function(index,item) {
						if(index<5) {
							suggestions_html+='<li><a href="#" onclick="searchByTerm(\''+item+'\');return false;"> '+item+'</li>';
							//console.log(item.title);
							index++;
						}
					});

				}
	//			console.log(suggestions_html);
				//openWindow(40, 500,4000,400,250,suggestions_html,'');
                                if(suggestionList.length>0) {
                                        suggestionList+='<li>&nbsp;</li>';
                                }

				suggestionList+=suggestions_html;
				//console.log(suggestionList);
				//openSuggestionBox('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
				$('.write_container .suggestions').html('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
		});
	}
	
	function searchWikiminer(term) {
		processArticleJSON(BY_TERM_JSON+term,term);
	}
	
//	http://words.bighugelabs.com/api/2/173aaf6b8cc559ac582b75f5ef7a8c8c/interface/json
	
	function processArticleJSON(url,term) {
	
				console.log('wiki search');
				$.getJSON(url, function(data) {
				json_cache = data;
				var sortedLinks = sortJSON(data,'relatedness');
				console.log(data.id);
				var suggestions_html ='';
				$.each(sortedLinks, function(index,item) {
					if(index<7) {
						suggestions_html+='<li><a href="#" onclick="searchByTerm(\''+item.title.toLowerCase()+'\');return false;"> '+item.title.toLowerCase()+' </a></li>';
						//console.log(item.title);
						index++;
					}
				});
//				console.log(suggestions_html);
				if(suggestionList.length>0) {
					suggestionList+='<li>&nbsp;</li>';
				}
				suggestionList+=suggestions_html;
				//console.log(suggestionList);

				//openWindow(40, 300,4000,400,250,suggestions_html,'');
				//openSuggestionBox('<ul class="wiki_suggestions">'+suggestionList+'</ul>');
				$('.write_container .suggestions').html('<ul class="wiki_suggestions">'+suggestionList+'</ul>');

			});
	}
	
	function sortJSON(data,sortMethod) {
		var ret;
		console.log(sortMethod);
		if(sortMethod=='relatedness') {
			ret=data.outLinks.sort(function(a,b) { return parseFloat(b.relatedness) - parseFloat(a.relatedness) } );
		}
		else {
			console.log('sort method is title');
			ret=data.outLinks.sort(function(a,b) { return a.title > b.title ? 1 : -1 } );
		}
		return ret;
	}
	
	function save_to_desktop() {
		var content = $('.window_frame #write_textarea').val();
		console.log('content '+content);
		/*$.ajax({
  			url: "save.php?method=desktop&content="+content,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		});*/
		window.open("save.php?method=desktop&content="+content,"_self")
		
	
	}
	
	function send_email() {
		var content = $('.window_frame #write_textarea').val();
		console.log('content '+content);
		/*$.ajax({
  			url: "save.php?method=desktop&content="+content,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		});*/
		
		//$( "#dialog-form" ).dialog( "open" );

		
		var to = prompt('email address (separated by comma)');
		if(to!=null && to!='') {
		  $.ajax({
  			url: "save.php?method=email&content="+content+"&to="+to,
			context: document.body
			}).done(function() { 
			  console.log('ajax done');
		  });
		
		}
		
		//	window.open("save.php?method=email&content="+content+"&to="+to,"_self")
	
	
	}
	
	function checkRegexp( o, regexp, n ) {
            if ( !( regexp.test( o.val() ) ) ) {
                o.addClass( "ui-state-error" );
                updateTips( n );
                return false;
            } else {
                return true;
            }
        }
	
	
</script>
</head>
<body>
	<div id="container">
	<!--	<div id="write" class="utilButton"><a href="#" onclick="openWriteBox();return false;">input box</a></div>
		<div id="start"><a href="#" onclick="openFirstBox();">start</a></div>
		
		<div id="write" class="utilButton"><a href="#" onclick="openWriteBox();return false;">write</a></div>
		<div id="save" class="utilButton"><a href="#" onclick="saveReading();return false;">save</a></div>
		<div id="load" class="utilButton"><a href="#" onclick="loadReading();return false;">load</a></div>-->
		
	<div class="search_input">
		<input type="text" class="search_box" tabindex="0" onkeyup="if (event.keyCode == 13) {search(this);}"/>
	</div>
		
 



	
	<div id="write_window" style="display:none">
		<div class="write_container window_container">
			<div class="suggestions">
			</div>
			<textarea class="write_note_box" id="write_textarea">&nbsp;</textarea>
			
			<!--<a href="#" onclick="addSelectionToBox()">Add selection to notes</a>-->
			<span class="save">
				<!--<a href="#" >&nbsp;</a>-->
			<ul class="save-options">
					<li><a href="#" onclick="save_to_desktop();return false;">desktop</a></li>
					<li><a href="#" onclick="send_email();return false;">email</a></li>
			</ul>
			
		</div>
	</div>
	<!--
	<div id="dialog-form" >
	
		<form>
		<fieldset>
			
			<label for="email">Email</label>
			<input type="text" name="email" id="email" value="" class="text ui-widget-content ui-corner-all" />
		</form>
		</fieldset>

	</div>
	
-->
	
	


	</div>

	<div id="tooltip" class="ui-corner-all">
<div class="loading"></div>
</div>
	
	

</body>
	
